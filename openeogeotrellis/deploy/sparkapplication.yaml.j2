---
apiVersion: "sparkoperator.k8s.io/v1beta2"
kind: SparkApplication
metadata:
  name: {{ job_name }}
  namespace: spark-jobs
spec:
  type: Python
  pythonVersion: "3"
  mode: cluster
  image: {{ image_name }}
  imagePullPolicy: Always
  timeToLiveSeconds: 604800
  mainApplicationFile: local:///opt/openeo/lib64/python3.8/site-packages/openeogeotrellis/deploy/batch_job.py
  arguments:
    - "{{ job_specification }}"
    - "{{ output_dir }}"
    - "{{ output_file }}"
    - "{{ log_file }}"
    - "{{ metadata_file }}"
    - "{{ api_version }}"
  sparkConf:
    "spark.rpc.message.maxSize": "200"
    "spark.rdd.compress": "true"
    "spark.driver.maxResultSize": "5g"
    "spark.blacklist.enabled": "true"
    "spark.speculation": "true"
    "spark.speculation.interval": "5000ms"
    "spark.speculation.multiplier": "4"
    "spark.kryoserializer.buffer.max": "1g"
    "spark.kryo.classesToRegister": "org.openeo.geotrellis.layers.BandCompositeRasterSource,geotrellis.raster.RasterRegion,geotrellis.raster.geotiff.GeoTiffResampleRasterSource,geotrellis.raster.RasterSource,geotrellis.raster.SourceName,geotrellis.raster.geotiff.GeoTiffPath"
    "spark.serializer": "org.apache.spark.serializer.KryoSerializer"
    "spark.dynamicAllocation.enabled": "true"
    "spark.dynamicAllocation.shuffleTracking.enabled": "true"
    "spark.decommission.enabled": "true"
    "spark.storage.decommission.shuffleBlocks.enabled": "true"
  sparkVersion: "3.2.0"
  restartPolicy:
    type: OnFailure
    onFailureRetries: 0
    onFailureRetryInterval: 10
    onSubmissionFailureRetries: 5
    onSubmissionFailureRetryInterval: 20
  volumes:
    - name: "eodata"
      hostPath:
        path: "/eodata"
        type: DirectoryOrCreate
  driver:
    envVars:
      OPENEO_CATALOG_FILES: "/opt/layercatalog.json"
      KUBE: "true"
      AWS_ACCESS_KEY_ID: {{ aws_access_key_id }}
      AWS_SECRET_ACCESS_KEY: {{ aws_secret_access_key }}
      AWS_VIRTUAL_HOSTING: "FALSE"
      SWIFT_URL: {{ swift_url }}
      SWIFT_BUCKET: {{ swift_bucket }}
      ZOOKEEPERNODES: {{ zookeeper_nodes }}
      OPENEO_S1BACKSCATTER_ELEV_GEOID: "/opt/openeo-vito-aux-data/egm96.grd"
      OTB_HOME: "/usr"
      OTB_APPLICATION_PATH: "/usr/lib/otb/applications"
      GDAL_NUM_THREADS: "2"
      GDAL_CACHEMAX: "200"
      GDAL_DISABLE_READDIR_ON_OPEN: "EMPTY_DIR"
      GDAL_HTTP_MERGE_CONSECUTIVE_RANGES: "YES"
      PYTHONPATH: "$PYTHONPATH:/opt/openeo/lib64/python3.8/site-packages"
      VSI_CACHE: "TRUE"
    cores: {{ driver_cores }}
    javaOptions: "-Dscala.concurrent.context.maxThreads=2 -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/data/projects/OpenEO/{{ current_time }}.hprof -Dlog4j.configuration=/opt/log4j.properties -Dlog4j.debug=true -Dpixels.treshold=1000000 -Dsoftware.amazon.awssdk.http.service.impl=software.amazon.awssdk.http.urlconnection.UrlConnectionSdkHttpService"
    memory: "{{ driver_memory }}"
    labels:
      version: 3.2.0
      name: {{ job_id }}-driver
    serviceAccount: openeo
    volumeMounts:
      - name: "eodata"
        mountPath: "/eodata"
      - name: "testdata"
        mountPath: "/data"
  executor:
    envVars:
      OPENEO_CATALOG_FILES: "/opt/layercatalog.json"
      KUBE: "true"
      AWS_ACCESS_KEY_ID: {{ aws_access_key_id }}
      AWS_SECRET_ACCESS_KEY: {{ aws_secret_access_key }}
      AWS_VIRTUAL_HOSTING: "FALSE"
      SWIFT_URL: {{ swift_url }}
      SWIFT_BUCKET: {{ swift_bucket }}
      ZOOKEEPERNODES: {{ zookeeper_nodes }}
      OPENEO_S1BACKSCATTER_ELEV_GEOID: "/opt/openeo-vito-aux-data/egm96.grd"
      OTB_HOME: "/usr"
      OTB_APPLICATION_PATH: "/usr/lib/otb/applications"
      GDAL_NUM_THREADS: "2"
      GDAL_CACHEMAX: "200"
      GDAL_DISABLE_READDIR_ON_OPEN: "EMPTY_DIR"
      GDAL_HTTP_MERGE_CONSECUTIVE_RANGES: "YES"
      PYTHON_MAX_MEMORY: "{{ python_max_memory }}"
      PYTHONPATH: "$PYTHONPATH:/opt/openeo/lib64/python3.8/site-packages"
      VSI_CACHE: "TRUE"
      CPL_DEBUG: "ON"
    cores: {{ executor_cores }}
    instances: {{ max_executors }}
    memory: "{{ executor_memory }}"
    memoryOverhead: "{{ executor_memory_overhead }}"
    javaOptions: "-Dlog4j.configuration=/opt/log4j.properties -Dscala.concurrent.context.numThreads=6 -Dscala.concurrent.context.maxThreads=6 -Dsoftware.amazon.awssdk.http.service.impl=software.amazon.awssdk.http.urlconnection.UrlConnectionSdkHttpService"
    labels:
      version: 3.2.0
    volumeMounts:
      - name: "eodata"
        mountPath: "/eodata"
  deps:
    jars:
      - 'local:///opt/geotrellis-extensions-2.3.0_2.12-SNAPSHOT.jar'
      - 'local:///opt/geotrellis-backend-assembly-0.4.6-openeo_2.12.jar'
    files:
      - 'local:///opt/layercatalog.json'
  monitoring:
    exposeDriverMetrics: true
    exposeExecutorMetrics: true
    prometheus:
      jmxExporterJar: "/opt/jmx_prometheus_javaagent-0.13.0.jar"
      port: 8090
